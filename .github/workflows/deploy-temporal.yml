name: Deploy Temporal Stack

on:
  push:
    branches:
      - main
    paths:
      - infra/temporal/**

  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-temporal-stack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Container Apps extension
        run: |
          az extension add --name containerapp --upgrade

      ###########################
      # Deploy PostgreSQL
      ###########################
      - name: Deploy PostgreSQL Container App
        run: |
          az containerapp create \
            --name temporal-db \
            --resource-group CyRev \
            --environment cyrev-env \
            --image postgres:14 \
            --cpu 0.5 \
            --memory 1Gi \
            --ingress internal \
            --secrets postgres-user=temporal postgres-pwd=temporal \
            --env-vars POSTGRES_USER=secretRef:postgres-user \
                       POSTGRES_PASSWORD=secretRef:postgres-pwd \
                       POSTGRES_DB=temporal

      ###########################
      # Deploy Elasticsearch
      ###########################
      - name: Deploy Elasticsearch Container App
        run: |
          az containerapp create \
            --name temporal-es \
            --resource-group CyRev \
            --environment cyrev-env \
            --image docker.elastic.co/elasticsearch/elasticsearch:8.11.1 \
            --cpu 1 \
            --memory 2Gi \
            --ingress internal \
            --env-vars discovery.type=single-node \
                       xpack.security.enabled=false

      ######################################################
      # Wait for Postgres + Elasticsearch to be Ready
      ######################################################
      - name: Wait for dependencies
        run: |
          echo "Waiting for Postgres and Elasticsearch to be ready..."
          for i in {1..30}; do
            POSTGRES_READY=$(az containerapp show \
              --name temporal-db \
              --resource-group CyRev \
              --query "latestRevision.status.conditions[?type=='Ready'].status" -o tsv)
            ES_READY=$(az containerapp show \
              --name temporal-es \
              --resource-group CyRev \
              --query "latestRevision.status.conditions[?type=='Ready'].status" -o tsv)

            echo "Postgres Ready: $POSTGRES_READY, Elasticsearch Ready: $ES_READY"

            if [[ "$POSTGRES_READY" == "True" ]] && [[ "$ES_READY" == "True" ]]; then
              echo "Dependencies are ready!"
              break
            fi
            echo "Dependencies not ready yet. Waiting 10s..."
            sleep 10
          done

          if [[ "$POSTGRES_READY" != "True" ]] || [[ "$ES_READY" != "True" ]]; then
            echo "ERROR: Dependencies did not become ready in time."
            exit 1
          fi

      ################################
      # Deploy Temporal App
      ################################
      - name: Deploy Temporal App
        run: |
          for attempt in {1..3}; do
            echo "Deploying Temporal (attempt $attempt)..."
            az containerapp create \
              --name temporal \
              --resource-group CyRev \
              --environment cyrev-env \
              --image temporalio/auto-setup:1.29.1 \
              --cpu 1 \
              --memory 2Gi \
              --ingress internal \
              --target-port 7233 \
              --secrets postgres-user=temporal postgres-pwd=temporal \
              --env-vars POSTGRES_SEEDS=temporal-db \
                         DB_PORT=5432 \
                         DB=postgres12 \
                         POSTGRES_USER=secretRef:postgres-user \
                         POSTGRES_PWD=secretRef:postgres-pwd \
                         ENABLE_ES=true \
                         ES_SEEDS=temporal-es \
                         ES_VERSION=v8 && break
            echo "Temporal deployment failed, retrying in 10s..."
            sleep 10
          done

      ################################
      # Wait for Temporal to be healthy
      ################################
      - name: Wait for Temporal Health
        run: |
          echo "Waiting for Temporal to become healthy..."
          for i in {1..30}; do
            STATUS=$(az containerapp show \
              --name temporal \
              --resource-group CyRev \
              --query "latestRevision.status.conditions[?type=='Ready'].status" -o tsv)

            echo "Temporal Ready Status: $STATUS"
            if [[ "$STATUS" == "True" ]]; then
              echo "Temporal is healthy!"
              break
            fi

            echo "Temporal not ready yet. Waiting 10s..."
            sleep 10
          done

          if [[ "$STATUS" != "True" ]]; then
            echo "ERROR: Temporal did not become healthy in time."
            exit 1
          fi

      ##########################
      # Deploy Temporal UI
      ##########################
      - name: Deploy Temporal UI
        run: |
          az containerapp create \
            --name temporal-ui \
            --resource-group CyRev \
            --environment cyrev-env \
            --image temporalio/ui:2.26.2 \
            --cpu 0.5 \
            --memory 1Gi \
            --ingress external \
            --target-port 8080 \
            --env-vars TEMPORAL_ADDRESS=temporal:7233
