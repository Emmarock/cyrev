name: Deploy Temporal Stack

on:
  push:
    branches:
      - main
    paths:
      - infra/temporal/**

  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-temporal-stack:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 2: Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 3: Install Container Apps extension
      - name: Install Container Apps extension
        run: |
          az extension add --name containerapp --upgrade

      ###########################
      # Step 4: Deploy PostgreSQL
      ###########################
      - name: Deploy PostgreSQL Container App
        run: |
          az containerapp create \
            --name temporal-db \
            --resource-group CyRev \
            --environment cyrev-env \
            --image postgres:14 \
            --cpu 0.5 \
            --memory 1Gi \
            --ingress internal \
            --secrets postgres-user=temporal postgres-pwd=temporal \
            --env-vars POSTGRES_USER=secretRef:postgres-user \
                       POSTGRES_PASSWORD=secretRef:postgres-pwd \
                       POSTGRES_DB=temporal

      ########################################
      # Step 5: Wait until Postgres is ready
      ########################################
      - name: Wait for Postgres to be ready
        run: |
          POSTGRES_HOST=temporal-db.cyrev-env.ukwest.internal.azurecontainerapps.io
          POSTGRES_PORT=5432
          echo "Waiting for PostgreSQL at $POSTGRES_HOST:$POSTGRES_PORT..."
          for i in {1..30}; do
            nc -zv $POSTGRES_HOST $POSTGRES_PORT && echo "Postgres is ready!" && exit 0
            echo "Postgres not ready yet. Waiting 5s..."
            sleep 5
          done
          echo "Postgres did not become ready in time."
          exit 1

      ################################
      # Step 6: Deploy Temporal App
      ################################
      - name: Deploy Temporal App
        run: |
          az containerapp create \
            --name temporal \
            --resource-group CyRev \
            --environment cyrev-env \
            --image temporalio/auto-setup:1.29.1 \
            --cpu 1 \
            --memory 2Gi \
            --ingress internal \
            --target-port 7233 \
            --secrets postgres-user=temporal postgres-pwd=temporal \
            --env-vars POSTGRES_SEEDS=temporal-db.cyrev-env.ukwest.internal.azurecontainerapps.io \
                       DB_PORT=5432 \
                       DB=postgres12 \
                       POSTGRES_USER=secretRef:postgres-user \
                       POSTGRES_PWD=secretRef:postgres-pwd \
                       ENABLE_ES=true \
                       ES_SEEDS=mysearch.search.windows.net \
                       ES_VERSION=v8

      ##########################
      # Step 7: Deploy Temporal UI
      ##########################
      - name: Deploy Temporal UI
        run: |
          az containerapp create \
            --name temporal-ui \
            --resource-group CyRev \
            --environment cyrev-env \
            --image temporalio/ui:2.26.2 \
            --cpu 0.5 \
            --memory 1Gi \
            --ingress external \
            --target-port 8080 \
            --env-vars TEMPORAL_ADDRESS=temporal.cyrev-env.ukwest.internal.azurecontainerapps.io:7233
