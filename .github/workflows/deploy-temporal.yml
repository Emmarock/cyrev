name: Deploy Temporal Stack

on:
  push:
    branches: [ main ]
    paths:
      - infra/temporal/**
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-temporal:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Container Apps extension
        run: |
          az extension add --name containerapp --upgrade

      # ------------------------------------------------------------
      # Ensure Postgres & Elasticsearch stay alive (NO scale-to-zero)
      # ------------------------------------------------------------
      - name: Pin replicas for Postgres and Elasticsearch
        run: |
          echo "Pinning Postgres and Elasticsearch replicas..."

          az containerapp update \
            --name temporal-db \
            --resource-group CyRev \
            --min-replicas 1 \
            --max-replicas 1

          az containerapp update \
            --name temporal-es \
            --resource-group CyRev \
            --min-replicas 1 \
            --max-replicas 1

      # ------------------------------------------------------------
      # Deploy / Update Temporal Server
      # ------------------------------------------------------------
      - name: Deploy Temporal Server
        run: |
          az containerapp create \
            --name temporal \
            --resource-group CyRev \
            --environment cyrev-env \
            --image temporalio/auto-setup:1.29.1 \
            --cpu 1 \
            --memory 2Gi \
            --ingress internal \
            --target-port 7233 \
            --min-replicas 1 \
            --max-replicas 1 \
            --secrets \
              postgres-user=temporal \
              postgres-pwd=temporal \
            --env-vars \
              POSTGRES_SEEDS=temporal-db \
              DB_PORT=5432 \
              DB=postgres12 \
              POSTGRES_USER=secretRef:postgres-user \
              POSTGRES_PWD=secretRef:postgres-pwd \
              ENABLE_ES=true \
              ES_SEEDS=temporal-es \
              ES_VERSION=v8

      # ------------------------------------------------------------
      # Deploy / Update Temporal UI
      # ------------------------------------------------------------
      - name: Deploy Temporal UI
        run: |
          az containerapp create \
            --name temporal-ui \
            --resource-group CyRev \
            --environment cyrev-env \
            --image temporalio/ui:2.26.2 \
            --cpu 0.5 \
            --memory 1Gi \
            --ingress external \
            --target-port 8080 \
            --min-replicas 1 \
            --max-replicas 1 \
            --env-vars \
              TEMPORAL_ADDRESS=temporal:7233
